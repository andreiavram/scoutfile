{% extends 'base.html' %}

{% block extrahead %}
	<script type = "text/javascript">
		function after_vote(data) {
			console.log(data);
			jQuery("#score_" + data.picture_id).html(data.current_score);
		}
	
		jQuery(document).ready(function () {
			jQuery(".thumbs_up").click(function (event) {
				console.log("thumbs_up");
				Dajaxice.scoutfile3.album.vote_picture(Dajax.process, {"picture_id" : jQuery(this).data("image"), "score" : 1});
				event.preventDefault();
				return false;
			});
			
			jQuery(".thumbs_down").click(function (event) {
				Dajaxice.scoutfile3.album.vote_picture(Dajax.process, {"picture_id" : jQuery(this).data("image"), "score" : -1});
				event.preventDefault();
				return false;
			});
			
			$(document).keydown(function(e){
			    {% if prev_photo %}
			    if (e.keyCode == 37) { 
			       	window.location.href = "{% url album:poza_detail pk=prev_photo.id %}{% if autor %}?autor={{ autor }}{% endif %}";
			       	return false;
			    }
			    {% endif %}
			    
			    {% if next_photo %}
			    if (e.keyCode == 39) {
			    	window.location.href = "{% url album:poza_detail pk=next_photo.id %}{% if autor %}?autor={{ autor }}{% endif %}";
			    	return false;
			    }
			    {% endif %}
			    
			    if (e.keyCode == 76) {
			    	//	l key was pressed = like
					Dajaxice.scoutfile3.album.vote_picture(Dajax.process, {"picture_id" : {{ object.id }}, "score" : 1});
			    	return false;
			    }
			    
			    if (e.keyCode == 72) {
			    	//	h key was pressed = hate
			    	Dajaxice.scoutfile3.album.vote_picture(Dajax.process, {"picture_id" : {{ object.id }}, "score" : -1});
			    	return false;
			    }
			    
			});			
		});
		
	</script>
{% endblock %}

{% block page_title %}
	{% if object.titlu %}{{ object.titlu }}{% else %}Imagine{% endif %}
	<div class = "pull-right btn-toolbar">
		<div class = "btn-group">
			<a class = "btn" href = "{% url album:poza_flag pk=object.id %}"><i class = "icon-flag"></i></a>
		</div>
		<div class = "btn-group">
			<a href = "{% url album:zi_detail pk=object.get_day.id %}?page={{ zi_page }}" class = "btn"><i class = "icon-chevron-up"></i></a>
		</div>
		<div class = "btn-group">
			<a href = "javascript:void()" class = "btn thumbs_up" data-image = "{{ object.id }}"><i class = "icon-thumbs-up"></i></a>
			<a href = "javascript:void()" class = "btn disabled" id = "score_{{ object.id }}">{{ object.score }}</a>
			<a href = "javascript:void()" class = "btn thumbs_down" data-image = "{{ object.id }}"><i class = "icon-thumbs-down"></i></a>
		</div>
		<div class = "btn-group">
			<a href = "{% url album:poza_rotate pk=object.id %}?direction=ccw" class = "btn"><i class = "icon-arrow-left"></i></a>
			<a href = "javascript:void();" class = "btn disabled"><i class = "icon-refresh"></i></a>
			<a href = "{% url album:poza_rotate pk=object.id %}?direction=cw" class = "btn"><i class = "icon-arrow-right"></i></a>
		</div>
		<div class = "btn-group">
			<a href = "{{ object.image.url }}" class = "btn"><i class = "icon-picture"></i> Original</a>
			<a href = "{{ object.get_profile_url }}" class = "btn"><i class = "icon-picture"></i> Profil</a>
		</div>

        {% if media_manager or request.user.is_superuser %}
        <div class = 'btn-group'>
            <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                <i class = "icon-eye-open"> </i> <span id = "current_visibility">{{ object.get_published_status_display }}</span>
                <span class="caret"></span>
            </a>
            <ul class="dropdown-menu">
                {% for state in visibility_states %}
                    <li><a href = "#" data-value = "{{ state.0 }}" class = "visibility_action">{{ state.1 }}</a></li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
	</div>
{% endblock %}

{% block context_menu %}
	<ul class = "nav nav-list">
		<li class = "nav-header">Acțiuni</li>
		<li class = "disabled"><a href = ""><i class = "icon-download"></i> Download toate</a>
		<li class = "disabled"><a href = ""><i class = "icon-download-alt"></i> Torrent</a>
		<li class = "nav-header">Locații</li>
		<li><a href = "{% url album:eveniment_detail slug=object.set_poze.eveniment.slug %}{% if autor %}?autor={{ autor }}{% endif %}"><i class = "icon-list"></i> {{ object.set_poze.eveniment }}</a></li>
		<li><a href = "{% url album:zi_detail pk=object.get_day.id %}{% if autor %}?autor={{ autor }}{% endif %}"><i class = "icon-list"></i> {{ object.get_day }}</a></li>

	    <li class = "nav-header">EXIF</li>
		{% for exif in object.interesting_exifdata %}
			<li><strong>{{ exif.key }}</strong>: {{ exif.value }}</li>
		{% endfor %}
		<li><strong>Autor</strong>: {{ object.set_poze.autor }}</li>
        <li class = "nav-header">Scurtături</li>
		<li><i class = "icon-arrow-left"></i> și <i class = "icon-arrow-right"></i> navigație poze</li>
        <li><em>L</em> pentru like</li>
        <li><em>H</em> pentru hate</li>
    </ul>

{% endblock %}

{% block content %}
{#	<div class = "well">{% if object.is_face_processed %}Face processed {{ object.detectedface_set.all.count }} faces found {% else %}not processed{% endif %}</div>#}
	{% if object.flagreport_set.all.count %}<div class = "alert alert-warning"><i class = "icon-flag"></i> Această poză a fost marcată de {% if object.flagreport_set.all.count > 1 %}mai mulți utilizatori{% else %}un utilizator{% endif %} ca nepotrivită pentru acest album, și urmează să fie analizată de un lider sau de fotograf.</div>{% endif %}
	<div class = "image-container" style = "position: relative; text-align: center; float:left; ">
		<div style = "margin-left: auto; margin-right: auto;width : {{ object.get_large_size.0 }}px; background-color: black; padding: 5px;">
		<div style = "float: left; height: 0;">
		{% for face in object.detectedface_set.all %}
			<div class = "face" style = "display: none; position: absolute; left: {% widthratio face.x object.resolution_x 960 %}px; top: {% widthratio face.y object.resolution_x 960 %}px; width: {% widthratio face.width object.resolution_x 960 %}px; height: {% widthratio face.height object.resolution_x 960 %}px; border: 3px dashed #3c3f41;"></div>
		{% endfor %}
		</div>

		<img src = "{{ object.get_large_url }}?{{ random_value }}" style = "" />
		{% if next_photo %}
			<div style = "position: absolute; right: 10px; top: 10px; padding: 3px 6px; background: #000; border: 1px solid #666">
				<a href = "{% url album:poza_detail pk=next_photo.id %}{% if autor %}?autor={{ autor }}{% endif %}"><i class = "icon-chevron-right icon-white"></i></a>
			</div>
		{% endif %}
		{% if prev_photo %}
			<div style = "position: absolute; left: 10px; top: 10px; padding: 3px 6px; background: #000; border: 1px solid #666">
				<a href = "{% url album:poza_detail pk=prev_photo.id %}{% if autor %}?autor={{ autor }}{% endif %}"><i class = "icon-chevron-left icon-white"></i></a>
			</div>
		{% endif %}
		
		<div style = "bottom: 10px; right: 10px; position: absolute; background: #000; color: #fff; border: 1px solid #666; opacity: 0.7; padding: 5px 10px;">&copy; {{ object.data|date:"Y" }}, {{ object.set_poze.autor }}</div>
		</div>
	</div>
{% endblock %}

{% block extrajs %}
    <script>
        $("document").ready(function () {
            $(".image-container").mouseenter(function () {
                $(".face").fadeIn(200);
            }).mouseleave(function () {
                        $(".face").fadeOut(200);
                    })

            //  change visibility settings
            $(".visibility_action").click(function (e) {
                $.post("{% url album:poza_visibility %}",
                        {"imagine": {{ object.id }}, "new_status": $(this).data("value"), "csrfmiddlewaretoken" : "{{ csrf_token }}"},
                        function (data) {
                            $("#current_visibility").fadeOut(200, function () {
                                console.log(data);
                                $(this).text(data.new_status_string);
                            }).fadeIn(200);
                        },
                        "json");
                e.preventDefault();
            });

        });


    </script>
{% endblock %}

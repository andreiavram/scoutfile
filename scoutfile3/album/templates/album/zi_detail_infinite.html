{% extends 'album/zi_base.html' %}
{% load staticfiles %}
{% load pagination_tags %}

{% block extrahead %}
    <link rel="stylesheet" href="{{ STATIC_URL }}generic/css/tagmanager.css"/>
    <script type="text/javascript">
        function after_vote(data) {
            console.log(data);
            jQuery("#score_" + data.picture_id).html(data.current_score);
        }


        function set_handlers(element) {
            jQuery(".thumbs_up", element).click(function (event) {
                Dajaxice.album.vote_picture(Dajax.process, {"picture_id": jQuery(this).data("image"), "score": 1});
                event.preventDefault();
                return false;
            });

            jQuery(".thumbs_down", element).click(function (event) {
                Dajaxice.album.vote_picture(Dajax.process, {"picture_id": jQuery(this).data("image"), "score": -1});
                event.preventDefault();
                return false;
            });

            jQuery(".rotate_cw", element).click(function (event) {
                var that = this;
                var d = new Date();
                jQuery.get($(this).attr('href'), function (data) {
                    $("#poza_" + $(that).data("image")).attr("src", data + "?" + d.getTime())
                });
                event.preventDefault();
            });

            jQuery(".rotate_ccw", element).click(function (event) {
                var that = this;
                var d = new Date();
                jQuery.get($(this).attr('href'), function (data) {
                    console.log(data, "here");
                    $("#poza_" + $(that).data("image")).attr("src", data + "?" + d.getTime())
                });
                event.preventDefault();
            });

            $(".imagine", element).popover({"placement": "bottom", "html": true, "trigger": "hover", "content": function () {
                return $($(this).data("contentsource")).html();
            }});

            $(".visibility_action", element).click(function (e) {
                var imagine_id = $(this).data("imagine");
                $.post("{% url album:poza_visibility %}",
                        {"imagine": $(this).data("imagine"), "new_status": $(this).data("value"), "csrfmiddlewaretoken": "{{ csrf_token }}", },
                        function (data) {
                            $("#current_visibility_" + imagine_id).fadeOut(200,function () {
                                console.log(data);
                                $(this).text(data.new_status_string);
                            }).fadeIn(200);
                        },
                        "json");
                e.preventDefault();
            });
        }
    </script>
{% endblock %}

{% block extrajs %}
    <script src="{{ STATIC_URL }}generic/js/typeahead.js"></script>
    <script src="{{ STATIC_URL }}generic/js/tagmanager.js"></script>
    <script src="{% static "js/underscore-min.js" %}"></script>
    <script src="{% static "js/backbone-min.js" %}"></script>

    <script>
        $(document).ready(function () {
            $(window).scroll(function () {
                if (($(window).scrollTop() >= $(document).height() - $(window).height() * 1.5) && !(stop_flag)) {
                    get_photos();
                }
            });
            get_photos();
        });

        var offset = 0;
        var limit = 9;
        var stop_flag = true;
        var crt_cnt = 0;

        function get_photos() {
            stop_flag = true;
            $.post("{% url album:imagine_search_json %}",
                    {"offset": offset, "limit": limit, "zi": {{ object.id }}, "csrfmiddlewaretoken": "{{ csrf_token }}", "ordering": "asc"},
                    function (data) {
                        {#                        $("#msg").html("<i class = 'icon-search'></i> Am găsit " + data.total_count + " imagini tag-uite cu <strong>" + $("[name='tags']").val() + "</strong>, cele mai recente mai sus");#}

                        $.each(data.data, function (index, element) {
                            if (crt_cnt % 4 == 0) {
                                $("#rezultate-list").append('<div class="row-fluid" style="margin-bottom: 20px"></div>');
                            }
                            $("#rezultate-list div.row-fluid:last-child").append(_.template($("#imagine_template").html(), {"image": element}));
                            var element = $("#rezultate-list div.row-fluid:last-child .span3:last-child");
                            set_handlers(element);
                            crt_cnt += 1;

                        });
                        offset += data.count;
                        if (offset < data.total_count) {
                            stop_flag = false;
                        } else {
                            stop_flag = true;
                        }
                    }, "json");

        }
    </script>
    <script>
        $("document").ready(function () {


        });
    </script>
    <script type="text/template" id="imagine_template">
        <div class="span3" style="position: relative;">
            <div class="thumbnail">
                <a href="<%= image.url_detail %>{% if autor %}?autor={{ autor }}{% endif %}">
                    <img src="<%= image.url_thumb %>" class="imagine" data-title = "<%= image.titlu %>" id = "poza_<%= image.id %>" data-contentsource = "#source_<%= image.id %>" />
                </a>
                <div style = "display:none" id = "source_<%= image.id %>">
                   Fotografie de <a href = "#"><i class = "icon-camera"></i> <%= image.autor %></a><br />
                   Moment <%= image.data %><br />
                    <% if (image.descriere) { %><%= image.descriere %><% } %>
                   <div class = "current-tags">
                    <% _.each(image.tags, function(e) { %>
                        <span class = "tag tag-small"><%= e %></span>
                    <% }); %>
                    </div>
                </div>
                <div class="btn-toolbar" style = "width: 91%; position: absolute; top: 0px; left: 10px">
                    <div class="btn-group" style=""
                         id="picture_<%= image.id %>">
                        <a href="javascript:void()" class="btn btn-mini thumbs_up" data-image="<%= image.id %>"><i
                                class="icon-thumbs-up"></i></a>
                        <a href="javascript:void()" class="btn btn-mini" style = "opacity: .8" id="score_<%= image.id %>"><%= image.score %></a>
                        <a href="javascript:void()" class="btn btn-mini thumbs_down" data-image="<%= image.id %>"><i
                                class="icon-thumbs-down"></i></a>
                    </div>
                    {% if media_manager or request.user.is_superuser %}
                        <div class="btn-group" style=""
                             id="picture_<%= image.id %>">
                            <a href = "<%= image.rotate_url %>?direction=ccw&size=thumbnail"  class="btn btn-mini rotate_ccw" data-image="<%= image.id %>"><i
                                    class="icon-rotate-left"></i></a>
                            <a href = "<%= image.rotate_url %>?direction=cw&size=thumbnail" class="btn btn-mini rotate_cw" data-image="<%= image.id %>"><i
                                    class="icon-rotate-right"></i></a>
                        </div>


                        <div class="btn-group">
                            <a class="btn btn-mini dropdown-toggle" data-toggle="dropdown" href="#">
                                <i class="icon-eye-open"> </i> <span
                                    id="current_visibility_<%= image.id %>"><%= image.published_status_display %></span>
                                <span class="caret"></span>
                            </a>
                            <ul class="dropdown-menu">
                                {% for state in visibility_states %}
                                    <li><a href="#" data-imagine="<%= image.id %>" data-value="{{ state.0 }}"
                                           class="visibility_action">{{ state.1 }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    <div class="btn-group pull-right">
                        <a href="<%= image.flag_url %>" class="btn btn-mini flag"
                           data-image="<%= image.id %>"><i class="icon-flag"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </script>
{% endblock %}



{% block content %}
    <div class="alert alert-info">Albumul pentru <a href="
            {% url album:eveniment_detail slug=object.eveniment.slug %}{% if autor %}?autor={{ autor }}{% endif %}"><i
            class="icon-list"></i> {{ object.eveniment }}</a>, <strong>{{ object.filter_photos.count }}</strong>
        fotografii pentru {{ object.date|date:"l, d F Y" }}</div>
    <div class="alert">Folosește varianta clasică cu paginație <a href="{% url album:zi_detail pk=object.id %}">aici</a>.
    </div>
    {% if autor %}
        <div class="alert alert-success">Arăt doar pozele de la <strong>{{ autor }}</strong></div>{% endif %}
    {% if object.descriere %}{{ object.descriere|linebreaks }}{% endif %}


    <div class="thumbnails" id="rezultate-list">
    </div>

{% endblock %}
